version: '3.8'

services:
  inference_server:
    build:
      context: ./services/inference_server
    image: agentic-garden/inference-server
    volumes:
      - ./services/inference_server/models:/app/models
      - ./services/inference_server/src:/app/src
    environment:
      - MODEL_NAME=${MODEL_NAME}
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  gsheets_server:
    build:
      context: ./services/gsheets_server
    image: agentic-garden/gsheets-server
    ports:
      - "8082:8000"
    volumes:
      - ./secrets:/app/secrets
      - ./services/gsheets_server/src:/app/src
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  cli_agent:
    build:
      context: ./clients/cli_agent
    image: agentic-garden/cli-agent
    depends_on:
      - inference_server
      - gsheets_server
    command: tail -f /dev/null
    volumes:
      - ./clients/cli_agent/src:/app/src
    environment:
      - INFERENCE_API_URL=http://inference_server:8000/v1/chat/completions
      - GSHEETS_API_URL=http://gsheets_server:8000